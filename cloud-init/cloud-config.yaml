#cloud-config
package_update: true
package_upgrade: false

packages:
  - nginx
  - python3
  - python3-venv
  - python3-pip
  - postgresql
  - redis-server
  - rsync
  - curl

write_files:
  - path: /etc/myapp/app.env
    permissions: '0644'
    content: |
      DB_DSN=dbname=demo user=demo password=demo host=127.0.0.1
      REDIS_URL=redis://127.0.0.1:6379/0

  - path: /etc/systemd/system/app.service
    permissions: '0644'
    content: |
      [Unit]
      Description=Gunicorn for Flask app
      After=network.target

      [Service]
      User=ubuntu
      Group=ubuntu
      EnvironmentFile=/etc/myapp/app.env
      WorkingDirectory=/opt/myapp
      ExecStart=/opt/venvs/myapp/bin/gunicorn --workers 2 --bind 127.0.0.1:5000 app:app
      Restart=always

      [Install]
      WantedBy=multi-user.target

  - path: /etc/nginx/sites-available/default
    permissions: '0644'
    content: |
      server {
        listen 80 default_server;
        listen [::]:80 default_server;

        root /var/www/html/react;
        index index.html;

        location /api/ {
          proxy_pass http://127.0.0.1:5000;
          proxy_set_header Host $host;
          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }

        location / {
          try_files $uri /index.html;
        }
      }

runcmd:
  # Create dirs
  - mkdir -p /opt/myapp
  - mkdir -p /opt/venvs
  - mkdir -p /var/www/html/react

  # Ensure ownership (for mounts and venv)
  - chown ubuntu:ubuntu /opt/myapp /opt/venvs /var/www/html/react

  # Setup Python venv
  - sudo -u ubuntu python3 -m venv /opt/venvs/myapp
  - sudo -u ubuntu /opt/venvs/myapp/bin/pip install -U pip setuptools wheel

  # Install app requirements once mount is ready
  - |
      echo "=== Waiting for /opt/myapp/requirements.txt ==="
      for i in {1..30}; do
        if [ -f /opt/myapp/requirements.txt ]; then
          echo "Found requirements.txt, installing..."
          sudo -u ubuntu /opt/venvs/myapp/bin/pip install -r /opt/myapp/requirements.txt
          exit 0
        fi
        echo "requirements.txt not found yet, retrying in 2s..."
        sleep 2
      done
      echo "WARNING: requirements.txt not found after 60s â€“ skipping install"

  # Configure PostgreSQL: db, user, table, sample data, grants
  - sudo -u postgres psql -tc "SELECT 1 FROM pg_database WHERE datname='demo'" | grep -q 1 || sudo -u postgres createdb demo
  - sudo -u postgres psql -tc "SELECT 1 FROM pg_roles WHERE rolname='demo'" | grep -q 1 || sudo -u postgres psql -c "CREATE USER demo WITH PASSWORD 'demo';"
  - sudo -u postgres psql -c "GRANT ALL PRIVILEGES ON DATABASE demo TO demo"
  - sudo -u postgres psql -d demo -c "CREATE TABLE IF NOT EXISTS items (id SERIAL PRIMARY KEY, name TEXT NOT NULL, description TEXT, created_at TIMESTAMPTZ DEFAULT NOW());"
  - sudo -u postgres psql -d demo -c "INSERT INTO items (name, description) VALUES ('The first one','Created by cloud-init'),('Second one','Also from cloud-init') ON CONFLICT DO NOTHING;"
  - sudo -u postgres psql -d demo -c "GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO demo;"
  - sudo -u postgres psql -d demo -c "GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA public TO demo;"

  # Redis tuning
  - echo 'vm.overcommit_memory=1' | tee /etc/sysctl.d/99-redis.conf
  - sysctl -p /etc/sysctl.d/99-redis.conf || true
  - systemctl enable --now redis-server

  # Enable app service
  - systemctl daemon-reload
  - systemctl enable --now app

  # Reload nginx
  - nginx -t
  - systemctl reload nginx
