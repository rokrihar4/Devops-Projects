#cloud-config
package_update: true
packages:
  - nginx
  - python3-pip
  - python3-venv
  - postgresql
  - redis-server

write_files:
  - path: /opt/myapp/app.py
    permissions: '0644'
    owner: www-data:www-data
    content: |
      from flask import Flask, jsonify
      import os, psycopg2, redis
      app = Flask(__name__)
      DB_DSN = os.getenv("DB_DSN", "dbname=demo user=demo password=demo host=127.0.0.1")
      REDIS_URL = os.getenv("REDIS_URL", "redis://127.0.0.1:6379/0")
      r = redis.from_url(REDIS_URL)
      def db_now():
          conn = psycopg2.connect(DB_DSN)
          cur = conn.cursor()
          cur.execute("SELECT now()")
          val = cur.fetchone()[0]
          cur.close(); conn.close()
          return val
      @app.route("/")
      def index():
          hits = r.incr("hits")
          return jsonify({"message":"Hello from Flask via Nginx + Gunicorn","hits":hits,"db_time":str(db_now())})
      if __name__ == "__main__":
          app.run(host="0.0.0.0", port=5000)

  - path: /opt/myapp/requirements.txt
    permissions: '0644'
    owner: www-data:www-data
    content: |
      flask==3.0.0
      gunicorn==21.2.0
      psycopg2-binary==2.9.9
      redis==5.0.1

  - path: /etc/myapp/app.env
    permissions: '0644'
    owner: root:root
    content: |
      DB_DSN=dbname=demo user=demo password=demo host=127.0.0.1
      REDIS_URL=redis://127.0.0.1:6379/0

  - path: /etc/nginx/sites-available/default
    permissions: '0644'
    owner: root:root
    content: |
      server {
        listen 80 default_server;
        listen [::]:80 default_server;
        root /var/www/html;
        index index.html;
        location / {
          proxy_pass http://127.0.0.1:5000;
          proxy_set_header Host $host;
          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }
      }

  - path: /etc/systemd/system/app.service
    permissions: '0644'
    owner: root:root
    content: |
      [Unit]
      Description=Gunicorn for Flask app
      After=network.target
      [Service]
      User=www-data
      Group=www-data
      EnvironmentFile=/etc/myapp/app.env
      WorkingDirectory=/opt/myapp
      ExecStart=/opt/myapp/.venv/bin/gunicorn --workers 2 --bind 127.0.0.1:5000 app:app
      Restart=always
      [Install]
      WantedBy=multi-user.target

runcmd:
  # Poskrbi, da se runcmd izvede po paketih (package_update/packages sta nad tem blokom)
  - [ bash, -lc, "sudo -u www-data python3 -m venv /opt/myapp/.venv" ]
  - [ bash, -lc, "/opt/myapp/.venv/bin/pip install -U pip" ]
  - [ bash, -lc, "/opt/myapp/.venv/bin/pip install -r /opt/myapp/requirements.txt" ]
  - [ bash, -lc, "sudo -u postgres psql -tc \"SELECT 1 FROM pg_database WHERE datname='demo'\" | grep -q 1 || sudo -u postgres createdb demo" ]
  - [ bash, -lc, "sudo -u postgres psql -tc \"SELECT 1 FROM pg_roles WHERE rolname='demo'\" | grep -q 1 || sudo -u postgres psql -c \"CREATE USER demo WITH PASSWORD 'demo';\"" ]
  - [ bash, -lc, "sudo -u postgres psql -c \"GRANT ALL PRIVILEGES ON DATABASE demo TO demo\"" ]
  - [ systemctl, enable, --now, redis-server ]
  - [ systemctl, enable, --now, nginx ]
  - [ systemctl, daemon-reload ]
  - [ systemctl, enable, --now, app ]

final_message: "Cloud-init: stack is up. Try curl http://<ip>/"
